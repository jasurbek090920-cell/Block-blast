<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Block Blast</title>
  <style>
    body { margin:0; display:flex; justify-content:center; align-items:center; height:100vh; background:#111; }
    canvas { background:#222; border:2px solid #fff; }
    #score { position:absolute; top:20px; left:20px; color:white; font-size:20px; }
  </style>
</head>
<body>
  <div id="score">Score: 0</div>
  <canvas id="game" width="300" height="400"></canvas>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const COLS = 10, ROWS = 15, SIZE = 25;
    let grid = Array.from({ length: ROWS }, () => Array(COLS).fill(0));
    const SHAPES = [
      [[1,1,1]], [[1],[1],[1]], [[1,1],[1,1]],
      [[1,1,0],[0,1,1]], [[0,1,1],[1,1,0]]
    ];
    let current = randomShape();
    let pos = { x: 3, y: 0 };
    let score = 0;

    function randomShape() { return SHAPES[Math.floor(Math.random()*SHAPES.length)]; }

    function drawGrid() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      for (let r=0;r<ROWS;r++) {
        for (let c=0;c<COLS;c++) {
          if (grid[r][c]) {
            ctx.fillStyle="cyan";
            ctx.fillRect(c*SIZE, r*SIZE, SIZE, SIZE);
          }
        }
      }
    }

    function drawShape() {
      ctx.fillStyle="yellow";
      for (let r=0;r<current.length;r++) {
        for (let c=0;c<current[r].length;c++) {
          if (current[r][c]) {
            ctx.fillRect((pos.x+c)*SIZE,(pos.y+r)*SIZE,SIZE,SIZE);
          }
        }
      }
    }

    function merge() {
      for (let r=0;r<current.length;r++) {
        for (let c=0;c<current[r].length;c++) {
          if (current[r][c]) grid[pos.y+r][pos.x+c]=1;
        }
      }
      clearLines();
    }

    function collide(yOff=1) {
      for (let r=0;r<current.length;r++) {
        for (let c=0;c<current[r].length;c++) {
          if (current[r][c]) {
            let newY=pos.y+r+yOff, newX=pos.x+c;
            if (newY>=ROWS || grid[newY][newX]) return true;
          }
        }
      }
      return false;
    }

    function drop() {
      if (!collide()) pos.y++;
      else { merge(); current=randomShape(); pos={x:3,y:0}; }
    }

    function clearLines() {
      for (let r=ROWS-1;r>=0;r--) {
        if (grid[r].every(cell=>cell)) {
          grid.splice(r,1);
          grid.unshift(Array(COLS).fill(0));
          score+=10;
          document.getElementById("score").innerText="Score: "+score;
          Telegram.WebApp.sendData(JSON.stringify({score:score})); // natijani botga yuborish
        }
      }
    }

    function loop() {
      drawGrid();
      drawShape();
      drop();
      setTimeout(loop,500);
    }

    document.addEventListener("keydown", e=>{
      if (e.key==="ArrowLeft" && pos.x>0) pos.x--;
      if (e.key==="ArrowRight" && pos.x<COLS-current[0].length) pos.x++;
      if (e.key==="ArrowDown") drop();
    });

    Telegram.WebApp.ready();
    loop();
  </script>
</body>
</html>
